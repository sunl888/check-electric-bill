
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电费余额图表</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/timezone.js"></script>
    <style>
        #main {
            width: 100%;
            height: 600px;
        }

        #date-picker {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="date-picker">
        <input type="datetime-local" id="start-date">
        <input type="datetime-local" id="end-date">
        <button onclick="updateChart()">查询</button>
    </div>
    <div id="main"></div>
    <script>
        dayjs.extend(window.dayjs_plugin_utc);
        dayjs.extend(window.dayjs_plugin_timezone);
        dayjs.tz.setDefault('Asia/Shanghai');

        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);
        var option;

        function fetchData(startDate, endDate) {
            return new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', `https://sunl888.github.io/check-electric-bill/data.csv`, true);
                xhr.onload = function () {
                    if (this.status === 200) {
                        var lines = this.responseText.split('\n').filter(line => line.trim()!== '');
                        var headers = lines[0].split(',');
                        var dateIndex = headers.indexOf('date');
                        var valueIndex = headers.indexOf('value');
                        var data = [];
                        for (var i = 1; i < lines.length; i++) {
                            var line = lines[i].split(',');
                            var date = line[dateIndex];
                            var value = parseFloat(line[valueIndex]);
                            if (dayjs(date).isBetween(startDate, endDate, null, '[]')) {
                                data.push({ date: date, value: value });
                            }
                        }

                        // 处理同一分钟内多条数据的情况
                        var processedData = [];
                        var currentMinute = null;
                        var minuteData = [];
                        for (var j = 0; j < data.length; j++) {
                            var currentDate = dayjs(data[j].date);
                            var currentMinuteStr = currentDate.format('YYYY-MM-DD HH:mm');
                            if (currentMinute === null) {
                                currentMinute = currentMinuteStr;
                                minuteData.push(data[j]);
                            } else if (currentMinute === currentMinuteStr) {
                                minuteData.push(data[j]);
                            } else {
                                var firstValue = minuteData[0].value;
                                var lastValue = minuteData[minuteData.length - 1].value;
                                processedData.push({ date: currentMinute, value: [firstValue, lastValue] });
                                currentMinute = currentMinuteStr;
                                minuteData = [data[j]];
                            }
                        }
                        if (minuteData.length > 0) {
                            var firstValue = minuteData[0].value;
                            var lastValue = minuteData[minuteData.length - 1].value;
                            processedData.push({ date: currentMinute, value: [firstValue, lastValue] });
                        }

                        resolve(processedData);
                    } else {
                        reject(new Error('数据获取失败'));
                    }
                };
                xhr.onerror = function () {
                    reject(new Error('请求出错'));
                };
                xhr.send();
            });
        }

        function updateChart() {
            var startDate = document.getElementById('start-date').value;
            var endDate = document.getElementById('end-date').value;
            if (startDate === '' || endDate === '') {
                alert('请选择完整的时间区间');
                return;
            }
            startDate = dayjs(startDate).format('YYYY-MM-DD HH:mm');
            endDate = dayjs(endDate).format('YYYY-MM-DD HH:mm');

            fetchData(startDate, endDate).then(data => {
                var xAxisData = [];
                var seriesData = [];
                var prevValue = null;
                for (var i = 0; i < data.length; i++) {
                    xAxisData.push(data[i].date);
                    var currentValue = data[i].value;
                    if (prevValue!== null && currentValue[0] > prevValue) {
                        seriesData.push({
                            value: currentValue,
                            itemStyle: {
                                color: 'red',
                                color0: 'red'
                            }
                        });
                    } else {
                        seriesData.push(currentValue);
                    }
                    prevValue = currentValue[1];
                }

                var timeDiff = dayjs(endDate).diff(dayjs(startDate));
                var xAxisType = 'category';
                if (timeDiff < 1000 * 60 * 60 * 24) {
                    // 时间区间小于一天，按小时排列
                    xAxisType = 'time';
                } else if (timeDiff < 1000 * 60 * 60 * 24 * 7) {
                    // 时间区间小于一周，按几小时排列
                    xAxisType = 'time';
                }

                option = {
                    title: {
                        text: '电费余额图表'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    xAxis: {
                        type: xAxisType,
                        data: xAxisData
                    },
                    yAxis: {},
                    series: [
                        {
                            type: 'candlestick',
                            data: seriesData
                        }
                    ]
                };

                myChart.setOption(option);
            }).catch(error => {
                console.error(error);
                alert('图表更新失败');
            });
        }
    </script>
</body>

</html>
