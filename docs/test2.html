<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>24小时电费监控</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div id="main" style="width: 100%;height:600px;"></div>

<script>
let rawData = [];
let myChart;
const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;

// 初始化图表
function initChart() {
    myChart = echarts.init(document.getElementById('main'));
    
    const option = {
        tooltip: { trigger: 'axis' },
        xAxis: { 
            type: 'time',
            axisLabel: {
                formatter: (value) => {
                    return echarts.time.format(value, '{HH}:{mm}', false);
                }
            }
        },
        yAxis: { scale: true },
        dataZoom: [{
            type: 'slider',
            start: 0,
            end: 100,
            minValueSpan: TWENTY_FOUR_HOURS,
            maxValueSpan: TWENTY_FOUR_HOURS,
            filterMode: 'none',
            height: 40,
            bottom: 20
        }],
        series: [{
            type: 'candlestick',
            itemStyle: {
                color: '#ef232a',
                color0: '#14b143',
                borderColor: '#ef232a',
                borderColor0: '#14b143'
            },
            data: []
        }]
    };
    myChart.setOption(option);
    
    // 滑动事件监听
    myChart.on('dataZoom', (params) => {
        const startValue = params.startValue || rawData[0].date;
        const endValue = new Date(startValue.getTime() + TWENTY_FOUR_HOURS);
        updateChart(startValue, endValue);
    });
}

// 处理24小时数据
function processData(start) {
    const end = new Date(start.getTime() + TWENTY_FOUR_HOURS);
    const filtered = rawData.filter(d => 
        d.date >= start && d.date <= end
    ).sort((a, b) => a.date - b.date);

    // 按15分钟分组
    const grouped = {};
    filtered.forEach(d => {
        const time = new Date(d.date);
        const minutes = time.getMinutes();
        const quarter = Math.floor(minutes / 15) * 15;
        const key = new Date(time);
        key.setMinutes(quarter, 0, 0);
        
        if (!grouped[key]) {
            grouped[key] = {
                open: d.value,
                close: d.value,
                high: d.value,
                low: d.value,
                time: key
            };
        } else {
            grouped[key].close = d.value;
            grouped[key].high = Math.max(grouped[key].high, d.value);
            grouped[key].low = Math.min(grouped[key].low, d.value);
        }
    });

    return Object.values(grouped).map(d => [
        d.time,
        d.open,
        d.close,
        d.low,
        d.high
    ]);
}

// 更新图表
function updateChart(start, end) {
    const seriesData = processData(start);
    
    myChart.setOption({
        xAxis: {
            min: start,
            max: end
        },
        series: [{
            data: seriesData
        }]
    });
}

// 加载CSV数据
async function loadData() {
    const response = await fetch('data.csv');
    const csv = await response.text();
    
    rawData = Papa.parse(csv, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        transform: (value, header) => {
            if (header === 'date') {
                return new Date(value);
            }
            return parseFloat(value);
        }
    }).data.sort((a, b) => a.date - b.date);

    // 初始化显示最后24小时
    const initialEnd = rawData[rawData.length-1].date;
    const initialStart = new Date(initialEnd.getTime() - TWENTY_FOUR_HOURS);
    updateChart(initialStart, initialEnd);
}

// 初始化
window.onload = async () => {
    initChart();
    await loadData();
};
</script>
</body>
</html>
