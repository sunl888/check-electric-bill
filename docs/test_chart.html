<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电费使用情况报表</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        #main {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1100px;
            height: 750px; /* 增加高度以适应滑动条 */
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            flex: 1;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="main">
        <div id="gauge-chart" class="chart-container"></div>
        <div id="line-chart" class="chart-container"></div>
    </div>
    <script>
        let lineChart, gaugeChart;
        let allData = [];

        Papa.parse('data.csv', {
            download: true,
            complete: function (results) {
                processData(results.data);
                initCharts();
            }
        });

        function processData(data) {
            const tempMap = new Map();
            data.forEach(row => {
                if (row.length >= 2) {
                    const dateStr = row[0].slice(0, 13).replace(/:\d{2}$/, '');
                    const timestamp = new Date(dateStr + ":00:00").getTime();
                    tempMap.set(timestamp, parseFloat(row[1]));
                }
            });
            
            // 转换为排序后的数组
            allData = Array.from(tempMap).sort((a, b) => a[0] - b[0]);
        }

        function initCharts() {
            lineChart = echarts.init(document.getElementById('line-chart'));
            gaugeChart = echarts.init(document.getElementById('gauge-chart'));

            const timeData = allData.map(item => item[0]);
            const valueData = allData.map(item => item[1]);

            const lineOption = {
                title: {
                    text: '用电趋势',
                    left: 'center',
                    textStyle: { fontSize: 24, fontWeight: 'bold' }
                },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'time',
                    axisLabel: { formatter: '{yyyy}-{MM}-{dd} {HH}:00' },
                    splitLine: { show: true, lineStyle: { color: '#eee' } }
                },
                yAxis: {
                    type: 'value',
                    splitLine: { show: true, lineStyle: { color: '#eee' } }
                },
                dataZoom: [{
                    type: 'slider',
                    show: true,
                    xAxisIndex: 0,
                    start: 50, // 初始显示后50%的数据
                    end: 100,
                    height: 20,
                    bottom: 10,
                    handleStyle: { color: '#1f77b4' }
                }],
                series: [{
                    name: '剩余电费',
                    type: 'line',
                    data: allData.map(item => [item[0], item[1]]),
                    smooth: true,
                    itemStyle: { color: '#1f77b4' },
                    areaStyle: { color: 'rgba(31, 119, 180, 0.2)' }
                }]
            };

            lineChart.setOption(lineOption);
            updateGauge(allData[allData.length - 1][1]);

            // 绑定dataZoom事件
            lineChart.on('dataZoom', function(params) {
                const options = lineChart.getOption();
                const startValue = options.dataZoom[0].startValue || timeData[0];
                const endValue = options.dataZoom[0].endValue || timeData[timeData.length - 1];
                
                // 找到可视范围内的最后一个数据点
                let lastValue = null;
                for (let i = allData.length - 1; i >= 0; i--) {
                    if (allData[i][0] <= endValue) {
                        lastValue = allData[i][1];
                        break;
                    }
                }
                if (lastValue !== null) {
                    updateGauge(lastValue);
                }
            });
        }

        function updateGauge(value) {
            gaugeChart.setOption({
                title: { text: '当前电费', left: 'center' },
                series: [{
                    max: 220,
                    name: '电费',
                    type: 'gauge',
                    detail: { formatter: '{value}' },
                    data: [{ value: value, name: '电费' }]
                }]
            });
        }
    </script>
</body>
</html>
