<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 保持head部分不变 -->
    <script>
        let lineChart, gaugeChart;
        let allData = [];

        Papa.parse('data.csv', {
            download: true,
            complete: function (results) {
                processData(results.data);
                initCharts();
            }
        });

        function processData(data) {
            const hourlyData = new Map();
            
            data.forEach(row => {
                if (row.length >= 2 && row[0]) {  // 添加空值检查
                    try {
                        const rawDate = new Date(row[0]);
                        const localHour = new Date(
                            rawDate.getFullYear(),
                            rawDate.getMonth(),
                            rawDate.getDate(),
                            rawDate.getHours()
                        );
                        const timestamp = localHour.getTime();
                        
                        // 过滤无效数值
                        const value = parseFloat(row[1]);
                        if (!isNaN(value)) {
                            hourlyData.set(timestamp, value);
                        }
                    } catch (e) {
                        console.warn('解析错误:', row);
                    }
                }
            });

            allData = Array.from(hourlyData)
                          .sort((a, b) => a[0] - b[0])
                          .map(item => ({
                            timestamp: item[0],
                            value: item[1]
                          }));
            
            console.log('处理后的数据:', allData);  // 调试输出
        }

        function initCharts() {
            lineChart = echarts.init(document.getElementById('line-chart'));
            gaugeChart = echarts.init(document.getElementById('gauge-chart'));

            const lineOption = {
                // 添加缺失的grid配置
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'time',
                    minInterval: 3600 * 1000,
                    boundaryGap: false,  // 添加边界间隔配置
                    axisLabel: {
                        formatter: function (value) {
                            const date = new Date(value);
                            return `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:00`;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    boundaryGap: ['10%', '10%']  // 添加y轴边界
                },
                series: [{
                    name: '剩余电费',
                    type: 'line',
                    data: allData.map(item => [item.timestamp, item.value]),
                    // 添加必要的系列配置
                    coordinateSystem: 'cartesian2d',  // 明确指定坐标系
                    showSymbol: false,
                    connectNulls: true
                }]
                // 其他配置保持不变...
            };

            // 确保数据有效
            if (allData.length === 0) {
                console.error('没有有效数据！');
                return;
            }

            lineChart.setOption(lineOption);
            // 其余代码保持不变...
        }
    </script>
</body>
</html>
