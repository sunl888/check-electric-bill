<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电费使用情况报表</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* 样式部分保持不变 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        #main {
            display: flex;
            flex-direction: column;
            width: 98%;
            height: 750px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            flex: 1;
            margin: 10px;
            min-width: 800px;
        }
    </style>
</head>
<body>
    <div id="main">
        <div id="gauge-chart" class="chart-container"></div>
        <div id="line-chart" class="chart-container"></div>
    </div>
    <script>
        let lineChart, gaugeChart;
        let allData = [];

        Papa.parse('data.csv', {
            download: true,
            complete: function (results) {
                processData(results.data);
                initCharts();
            }
        });

        function processData(data) {
            const hourlyData = new Map();
            
            data.forEach(row => {
                if (row.length >= 2) {
                    // 修正时间处理逻辑
                    const rawDate = new Date(row[0]);
                    // 转换为本地时间整点
                    const localHour = new Date(
                        rawDate.getFullYear(),
                        rawDate.getMonth(),
                        rawDate.getDate(),
                        rawDate.getHours()
                    );
                    const timestamp = localHour.getTime();
                    
                    // 保留最后一个出现的小时数据
                    hourlyData.set(timestamp, parseFloat(row[1]));
                }
            });

            allData = Array.from(hourlyData)
                          .sort((a, b) => a[0] - b[0])
                          .map(item => ({
                            timestamp: item[0],
                            value: item[1]
                          }));
        }

        function initCharts() {
            lineChart = echarts.init(document.getElementById('line-chart'));
            gaugeChart = echarts.init(document.getElementById('gauge-chart'));

            const lineOption = {
                title: {
                    text: '用电趋势（每小时数据）',
                    left: 'center',
                    textStyle: { fontSize: 24, fontWeight: 'bold' }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const date = new Date(params[0].value[0]);
                        // 显示完整本地时间
                        return `${date.toLocaleString()}<br/>电费：${params[0].value[1]}`;
                    }
                },
                xAxis: {
                    type: 'time',
                    minInterval: 3600 * 1000,
                    axisLabel: {
                        formatter: function (value) {
                            // 修正时间格式化
                            const date = new Date(value);
                            // 显示日期和小时
                            return `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:00`;
                        }
                    },
                    splitLine: { show: true, lineStyle: { color: '#eee' } }
                },
                /* 其他配置保持不变 */
                // ... [保持原有配置不变]
            };

            lineChart.setOption(lineOption);
            updateGauge(allData[allData.length - 1].value);

            lineChart.on('dataZoom', function(params) {
                // 保持原有逻辑不变
                const options = lineChart.getOption();
                const currentRange = options.dataZoom[0];
                const startValue = currentRange.startValue || allData[0].timestamp;
                const endValue = currentRange.endValue || allData[allData.length - 1].timestamp;
                
                const lastVisibleData = allData.reduce((acc, curr) => {
                    return (curr.timestamp <= endValue) ? curr : acc;
                }, { value: 0 });

                updateGauge(lastVisibleData.value);
            });
        }

        function updateGauge(value) {
            // 仪表盘配置保持不变
            gaugeChart.setOption({
                /* 原有配置 */
            });
        }
    </script>
</body>
</html>
